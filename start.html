<!-- ✅ Already included in your message, skipping unchanged <head> and <style> -->

<script>
  const voiceSelect = document.getElementById('voiceSelect');
  const languageSelect = document.getElementById('languageSelect');
  const levelSelect = document.getElementById('levelSelect');
  const generateBtn = document.getElementById('generateBtn');
  const askBtn = document.getElementById('askBtn');
  const continueBtn = document.getElementById('continueBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const outputText = document.getElementById('outputText');
  const userName = document.getElementById('userName');

  const sessionId = localStorage.getItem('sessionId') || crypto.randomUUID();
  localStorage.setItem('sessionId', sessionId);
  let sessionMessages = JSON.parse(localStorage.getItem('sessionMessages')) || [];

  async function loadVoices(languageCode) {
    const response = await fetch('/api/get-voices');
    const voices = await response.json();
    voiceSelect.innerHTML = '';
    const filtered = voices.filter(v => v.labels?.language?.toLowerCase().startsWith(languageCode));
    if (filtered.length === 0) {
      voiceSelect.innerHTML = '<option disabled selected>No voices available for this language</option>';
    } else {
      filtered.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.voice_id;
        option.textContent = `${voice.name} (${voice.labels?.accent || 'Default'})`;
        voiceSelect.appendChild(option);
      });
    }
  }

  function saveSessionLocally() {
    localStorage.setItem('sessionMessages', JSON.stringify(sessionMessages));
  }

  async function saveSessionServer() {
    await fetch('/api/save-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, messages: sessionMessages })
    });
  }

  async function loadSessionServer() {
    const res = await fetch(`/api/get-session?sessionId=${sessionId}`);
    const data = await res.json();
    sessionMessages = data.messages || [];
  }

  async function generateStory(promptText) {
    const voiceId = voiceSelect.value;
    const name = userName.value.trim();
    if (!voiceId || !name) {
      alert("Please enter your name and choose a voice.");
      return;
    }

    if (!audioPlayer.paused) audioPlayer.pause();

    sessionMessages.push({ role: 'user', content: promptText });

    const response = await fetch('/api/generate-story', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: promptText, sessionId, messages: sessionMessages, userName: name })
    });

    const data = await response.json();
    const story = data.text;
    if (!story) return;

    outputText.textContent = story;
    sessionMessages.push({ role: 'assistant', content: story });
    saveSessionLocally();
    await saveSessionServer();

    // ✅ Use ElevenLabs streaming endpoint
    const streamURL = `/stream-voice?text=${encodeURIComponent(story)}&voiceId=${voiceId}`;
    audioPlayer.src = streamURL;
    audioPlayer.play();

    continueBtn.style.display = 'block';
  }

  generateBtn.addEventListener('click', () => {
    const langText = languageSelect.options[languageSelect.selectedIndex].text;
    const level = levelSelect.value;
    const name = userName.value.trim();
    const prompt = `Explain AI to ${name}, using ${langText}, keeping it at a ${level} level. Make it feel like a personal TED Talk.`;
    generateStory(prompt);
  });

  continueBtn.addEventListener('click', () => {
    const name = userName.value.trim();
    const level = levelSelect.value;
    const prompt = `Continue the story with more insights at ${level} level and keep addressing ${name} personally.`;
    generateStory(prompt);
  });

  askBtn.addEventListener('click', () => {
    if (!audioPlayer.paused) audioPlayer.pause();

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = languageSelect.value === 'da' ? 'da-DK' :
                       languageSelect.value === 'es' ? 'es-ES' :
                       languageSelect.value === 'fr' ? 'fr-FR' : 'en-US';

    recognition.onresult = (event) => {
      const question = event.results[0][0].transcript;
      outputText.textContent = `🎤 You asked: ${question}`;
      generateStory(question);
    };

    recognition.onerror = (event) => {
      outputText.textContent = `❌ Error: ${event.error}`;
    };

    recognition.start();
  });

  languageSelect.addEventListener('change', async () => {
    await loadVoices(languageSelect.value);
  });

  window.onload = async () => {
    await loadVoices(languageSelect.value);
    await loadSessionServer();
    const last = sessionMessages.find(m => m.role === 'assistant');
    if (last) outputText.textContent = last.content;
  };
</script>
