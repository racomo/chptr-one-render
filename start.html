<!-- ... (keep your existing HTML above) -->

<script>
  const voiceSelect = document.getElementById('voiceSelect');
  const generateButton = document.getElementById('generateBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const outputText = document.getElementById('outputText');

  async function loadVoices() {
    try {
      const response = await fetch('/api/get-voices');
      const voices = await response.json();

      voiceSelect.innerHTML = '';
      voices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.voice_id;
        option.textContent = `${voice.name} (${voice.labels?.accent || 'Default'})`;
        voiceSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Failed to fetch voices:', error);
      outputText.textContent = '❌ Could not load voices.';
    }
  }

  async function generateAudio() {
    const language = document.getElementById('languageSelect').value;
    const level = document.getElementById('levelSelect').value;
    const voiceId = voiceSelect.value;

    if (!voiceId) {
      outputText.textContent = '⚠️ Please select a voice.';
      return;
    }

    const prompt = `Act like an accomplished speechwriter and public speaking coach.
You mastered every precept from the book "Talk like TED".
Your expertise lies in crafting captivating and influential speeches, with a specialization in TED-style presentations.

Your objective is to narrate a public speaking story that resonates with the essence of a TED Talk. 
This story should be thought-provoking, inspiring, and geared towards a global audience. 
Make it sound human, emotional, and easy to understand — using middle school English.

Use storytelling, metaphors, vivid examples, and speak directly to the listener.

Explain Artificial Intelligence in a way that fits this profile:
• Language: ${language}
• Level: ${level}

Draw inspiration from:
- https://www.elementsofai.com/
- Stanford’s AI resources
- MIT OpenCourseWare
- DeepLearning.ai
- Any public university curriculum

End with a powerful call to action that makes AI feel exciting and doable for someone at this level.`;

    try {
      outputText.textContent = '🧠 Generating story...';
      generateButton.disabled = true;

      const gptResponse = await fetch('/api/generate-story', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      const gptData = await gptResponse.json();
      const story = gptData.text;

      if (!story) {
        outputText.textContent = '❌ No story returned.';
        return;
      }

      outputText.textContent = story;

      const ttsResponse = await fetch('/api/narrate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: story, voiceId })
      });

      if (!ttsResponse.ok) {
        outputText.textContent = '❌ Voice generation failed.';
        return;
      }

      const audioBlob = await ttsResponse.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.play();
    } catch (err) {
      console.error('⚠️ Error:', err);
      outputText.textContent = 'Something went wrong. Please try again.';
    } finally {
      generateButton.disabled = false;
    }
  }

  window.onload = () => {
    loadVoices();
    generateButton.addEventListener('click', generateAudio);
  };
</script>
