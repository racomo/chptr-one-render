const elevenApiKey = 'YOUR_ELEVENLABS_API_KEY'; // Replace with your actual key
const voiceSelect = document.getElementById('voiceSelect');
const generateButton = document.getElementById('generateBtn');
const audioPlayer = document.getElementById('audioPlayer');
const outputText = document.getElementById('outputText');

// Fetch and populate voice list from ElevenLabs
async function loadVoices() {
  try {
    const response = await fetch('https://api.elevenlabs.io/v1/voices', {
      headers: { 'xi-api-key': elevenApiKey }
    });

    const data = await response.json();

    data.voices.forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.voice_id;
      option.textContent = voice.name;
      voiceSelect.appendChild(option);
    });
  } catch (err) {
    console.error('Failed to load voices:', err);
  }
}

// Generate and play audio
async function generateAudio() {
  const userName = document.getElementById('userName').value || 'Friend';
  const language = document.getElementById('languageSelect').value;
  const level = document.getElementById('levelSelect').value;
  const voiceId = voiceSelect.value;

  const prompt = `Explain what AI is to a ${level} in ${language} using friendly storytelling.`;

  if (!voiceId) {
    outputText.textContent = 'Please select a voice.';
    return;
  }

  try {
    outputText.textContent = 'Generating...';

    // Step 1: Get the story from OpenAI
    const gptResponse = await fetch('/api/generate-story', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    const gptData = await gptResponse.json();
    const story = gptData.text;

    outputText.textContent = story;

    // Step 2: Convert to speech with ElevenLabs
    const ttsResponse = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
      method: 'POST',
      headers: {
        'xi-api-key': elevenApiKey,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: story,
        model_id: 'eleven_monolingual_v1',
        voice_settings: { stability: 0.5, similarity_boost: 0.5 }
      })
    });

    if (!ttsResponse.ok) {
      const error = await ttsResponse.json();
      console.error('TTS Error:', error);
      outputText.textContent = 'Voice generation failed.';
      return;
    }

    const audioBlob = await ttsResponse.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    audioPlayer.src = audioUrl;
    audioPlayer.play();
  } catch (err) {
    console.error('Error during generation:', err);
    outputText.textContent = 'Something went wrong.';
  }
}

// Wire up actions
window.onload = () => {
  loadVoices();
  generateButton.addEventListener('click', generateAudio);
};
