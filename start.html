<script>
  const voiceSelect = document.getElementById('voiceSelect');
  const languageSelect = document.getElementById('languageSelect');
  const levelSelect = document.getElementById('levelSelect');
  const generateButton = document.getElementById('generateBtn');
  const askButton = document.getElementById('askBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const outputText = document.getElementById('outputText');

  const sessionId = localStorage.getItem('sessionId') || crypto.randomUUID();
  localStorage.setItem('sessionId', sessionId);
  let userName = localStorage.getItem('userName') || '';

  let sessionMessages = JSON.parse(localStorage.getItem('sessionMessages')) || [];

  const languageVoiceMap = {
    English: ['en', 'us', 'gb', 'english'],
    Danish: ['da', 'danish'],
    Spanish: ['es', 'spanish'],
    French: ['fr', 'french']
  };

  async function loadVoicesForLanguage(lang) {
    const res = await fetch('/api/get-voices');
    const voices = await res.json();

    const filters = languageVoiceMap[lang] || [];
    const filtered = voices.filter(v =>
      filters.some(f =>
        (v.labels?.accent || '').toLowerCase().includes(f) ||
        (v.name || '').toLowerCase().includes(f) ||
        (v.labels?.language || '').toLowerCase().includes(f)
      )
    );

    voiceSelect.innerHTML = '';
    (filtered.length > 0 ? filtered : voices).forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.voice_id;
      option.textContent = `${voice.name} (${voice.labels?.accent || 'Default'})`;
      voiceSelect.appendChild(option);
    });
  }

  function saveSessionLocally() {
    localStorage.setItem('sessionMessages', JSON.stringify(sessionMessages));
  }

  async function saveSessionServer() {
    await fetch('/api/save-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, messages: sessionMessages })
    });
  }

  async function loadSessionServer() {
    const res = await fetch(`/api/get-session?sessionId=${sessionId}`);
    const data = await res.json();
    sessionMessages = data.messages || [];
  }

  async function generateStory(promptText) {
    const voiceId = voiceSelect.value;
    if (!voiceId) return;

    sessionMessages.push({ role: 'user', content: promptText });

    const response = await fetch('/api/generate-story', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: promptText, sessionId, messages: sessionMessages, userName })
    });

    const data = await response.json();
    const story = data.text;
    if (!story) return;

    outputText.textContent = story;
    sessionMessages.push({ role: 'assistant', content: story });
    saveSessionLocally();
    await saveSessionServer();

    const ttsResponse = await fetch('/api/narrate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: story, voiceId })
    });

    const audioBlob = await ttsResponse.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    audioPlayer.src = audioUrl;
    audioPlayer.play();
  }

  generateButton.addEventListener('click', () => {
    const language = languageSelect.value;
    const level = levelSelect.value;
    const prompt = `Explain AI in middle school English. Language: ${language}, Level: ${level}`;
    generateStory(prompt);
  });

  askButton.addEventListener('click', () => {
    if (audioPlayer && !audioPlayer.paused) {
      audioPlayer.pause();
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.onresult = (event) => {
      const question = event.results[0][0].transcript;
      outputText.textContent = `🎤 You asked: ${question}`;
      generateStory(question);
    };
    recognition.onerror = (event) => {
      outputText.textContent = `❌ Error: ${event.error}`;
    };
    recognition.start();
  });

  window.onload = async () => {
    document.getElementById('languageSelect').innerHTML = `
      <option>English</option><option>Danish</option><option>Spanish</option><option>French</option>`;
    document.getElementById('levelSelect').innerHTML = `
      <option value="beginner">Beginner</option>
      <option value="intermediate">Intermediate</option>
      <option value="advanced">Advanced</option>`;

    const name = prompt("👋 Welcome! What’s your first name?");
    if (name) {
      userName = name;
      localStorage.setItem('userName', name);
    }

    const selectedLanguage = languageSelect.value || 'English';
    await loadVoicesForLanguage(selectedLanguage);
    languageSelect.addEventListener('change', e => loadVoicesForLanguage(e.target.value));

    await loadSessionServer();
    const last = sessionMessages.find(m => m.role === 'assistant');
    if (last) outputText.textContent = last.content;
  };
</script>
