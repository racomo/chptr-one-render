window.addEventListener('DOMContentLoaded', () => {
  const voiceSelect = document.getElementById('voiceSelect');
  const generateButton = document.getElementById('generateBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const outputText = document.getElementById('outputText');

  const availableVoices = [
    { voice_id: 'EXAVITQu4vr4xnSDxMaL', name: 'Rachel (English Female)' },
    { voice_id: 'TxGEqnHWrfWFTfGW9XjX', name: 'Default Male' }
  ];

  function loadVoices() {
    voiceSelect.innerHTML = '';
    availableVoices.forEach(voice => {
      const option = document.createElement('option');
      option.value = voice.voice_id;
      option.textContent = voice.name;
      voiceSelect.appendChild(option);
    });
  }

  async function generateAudio() {
    const language = document.getElementById('languageSelect').value;
    const level = document.getElementById('levelSelect').value;
    const voiceId = voiceSelect.value;

    if (!voiceId) {
      outputText.textContent = '‚ö†Ô∏è Please select a voice.';
      return;
    }

    const prompt = `Explain what AI is to a ${level} in ${language} using friendly storytelling.`;

    try {
      outputText.textContent = 'üß† Generating story...';
      generateButton.disabled = true;

      // Step 1: Call backend to get OpenAI-generated story
      const gptResponse = await fetch('/api/generate-story', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      if (!gptResponse.ok) {
        throw new Error('Failed to generate story');
      }

      const gptData = await gptResponse.json();
      const story = gptData.text;

      if (!story) {
        outputText.textContent = '‚ùå No story returned.';
        return;
      }

      outputText.textContent = story;

      // Step 2: Get narration via backend proxy
      const ttsResponse = await fetch('/api/narrate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: story, voiceId })
      });

      if (!ttsResponse.ok) {
        outputText.textContent = '‚ùå Voice generation failed.';
        return;
      }

      const audioBlob = await ttsResponse.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.play();
    } catch (err) {
      console.error('‚ö†Ô∏è Error:', err);
      outputText.textContent = 'Something went wrong. Please try again.';
    } finally {
      generateButton.disabled = false;
    }
  }

  // Init
  loadVoices();
  generateButton.addEventListener('click', generateAudio);
});
